# Context Builder Skill
上下文构建技能 - 从多个文档中提取并整合相关内容

---

## 技能说明
接收相关文档列表，智能提取关键段落，构建精简的上下文供 Claude 分析。

## 输入参数
- `documents`: 文档列表（来自 Smart Retrieval Skill）
- `query`: 用户问题
- `max_tokens`: 最大上下文长度（默认 10000 tokens）

---

## 执行逻辑

### 1. 批量读取文档

使用 MCP 工具 `parse_document_smart` 并行读取文档:

```
mcp_tool: parse_document_smart
params: {
  file_path: "文档路径",
  mode: "targeted",  # 针对性提取模式
  keywords: [从 query 提取的关键词]
}
```

返回: 包含关键词的段落及上下文

### 2. 段落提取

对每个文档提取相关段落:
- 包含关键词的段落
- 该段落的上下文（前后各 1-2 段）
- 段落所在位置（页码/段落号）

### 3. 去重和排序

- **去重**: 合并相似内容（使用简单的文本相似度）
- **排序**: 按相关度排序段落
  - 关键词密度
  - 段落长度（过短或过长降低优先级）
  - 文档的整体相关度

### 4. Token 预算管理

如果提取的内容超过 max_tokens:
- **优先保留**: 高相关度段落（前 60%）
- **摘要处理**: 中相关度段落生成摘要（30%）
- **仅引用**: 低相关度段落仅保留引用（10%）

Token 估算（简化）:
```
1 中文字 ≈ 2 tokens
1 英文词 ≈ 1 token
```

### 5. 构建结构化上下文

返回 Markdown 格式:

```markdown
## 📚 相关文档摘要

### 文档1: [标题](路径)
**文件类型**: PDF | **修改时间**: 2025-10-15 | **相关度**: 95%

**关键段落**:
> 项目当前预算为 500 万元，其中人力成本占 60%，硬件采购占 25%...
>
> 📄 来源: 第 3 页

**关键信息**:
- 总预算: 500 万元
- 人力成本: 300 万元（60%）
- 硬件采购: 125 万元（25%）

---

### 文档2: [标题](路径)
**文件类型**: Word | **修改时间**: 2025-10-10 | **相关度**: 87%

**关键段落**:
> 根据最新风险评估，预算储备仅为 5%，低于行业标准...
>
> 📄 来源: 第 12 段

**关键信息**:
- 预算储备: 5%
- 行业标准: 10-15%
- 风险等级: 高

---

## 🔍 跨文档发现

### 共同主题
- 预算约束: 两份文档都提到预算紧张
- 风险意识: 多处提及风险管理

### 矛盾或差异
- 文档1 未提及风险储备不足，文档2 明确指出此问题

### 关键数据汇总
| 指标 | 数值 | 来源 |
|------|------|------|
| 总预算 | 500万 | 文档1 |
| 预算储备 | 5% | 文档2 |
| 行业标准 | 10-15% | 文档2 |
```

---

## Token 预算示例

假设 max_tokens = 10000:

| 内容类型 | Token 分配 | 说明 |
|---------|-----------|------|
| 高相关度段落（完整） | 6000 | 直接引用原文 |
| 中相关度段落（摘要） | 3000 | 压缩后的要点 |
| 文档元数据和引用 | 1000 | 文档信息、表格等 |

---

## 使用示例

在 Commands 中调用:

```markdown
使用 /skill custom/context-builder:
- documents: [Smart Retrieval 的输出]
- query: "项目风险有哪些？"
- max_tokens: 10000

返回: 结构化上下文（Markdown 格式）
```

---

## 高级功能

### 1. 智能摘要
对长段落自动生成摘要:
- 提取主题句
- 保留关键数据
- 去除冗余描述

### 2. 表格提取
如果文档包含表格数据，提取并格式化:
```markdown
| 列1 | 列2 | 列3 |
|-----|-----|-----|
| 数据 | 数据 | 数据 |
```

### 3. 引用管理
自动为每个引用段落添加来源标注:
```
> [引用内容]
> 📄 来源: 文档名.pdf 第 X 页
```

---

## 性能优化

- 并行读取文档（如果 MCP 支持）
- 缓存已读取的文档内容
- 增量构建上下文（优先级队列）

---

## 错误处理

- 文档无法读取: 跳过并记录
- 超过 Token 限制: 自动压缩
- 无相关内容: 返回空上下文，提示扩大搜索范围
