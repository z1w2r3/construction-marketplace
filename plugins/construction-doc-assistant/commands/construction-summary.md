# 建筑施工项目总结生成

生成项目总结报告,支持整体总结、阶段总结和时期总结。

你现在要执行项目总结生成任务,参数: $ARGUMENTS

## 执行步骤

### 1. 读取项目配置

从 `.claude/CLAUDE-construction.md` 读取:
- 项目名称
- 原文档目录路径
- 项目类型
- 参建单位信息

使用 Read 工具读取配置文件,如果不存在则提示用户先运行 `/construction-init`。

### 2. 确定总结范围

根据参数确定范围:
- 无参数 → 整体总结(项目全周期)
- "阶段名称" → 该阶段总结(如"主体结构阶段")
- "时期" → 该时期总结(如"2024年9月")

### 3. 识别关键文档

根据总结范围,识别需要读取的文档类型:

**整体总结需要**:
- 项目概况文档 (*.pptx, *.docx)
- 总体进度文档
- 竣工验收文档
- 项目总结类文档

**阶段总结需要**:
- 阶段施工方案
- 阶段验收记录
- 阶段月报/周报

**时期总结需要**:
- 该时期的月报
- 该时期的检查记录
- 该时期的会议纪要

使用 Bash 工具查找文档:
```bash
# 整体总结文档查找
find "原文档目录" -type f \( -name "*概况*.pptx" -o -name "*概况*.docx" -o -name "*概况*.pdf" \)
find "原文档目录" -type f \( -name "*总结*.docx" -o -name "*总结*.xlsx" \)
find "原文档目录" -type f \( -name "*月报*.docx" -o -name "*月报*.xlsx" \)

# 阶段总结文档查找
find "原文档目录" -type f -name "*[阶段名称]*.docx"

# 时期总结文档查找
find "原文档目录" -type f -name "*[年月]*.docx"
```

### 4. 验证和解析文档 ⭐ (核心改进)

对找到的每个文档,按以下步骤处理:

#### 4.1 验证文档可读性

```
使用 mcp__construction_doc_processor__validate_document 工具验证:
- file_path: [文档绝对路径]

返回结果:
- valid: true → 文档可读,继续解析
- valid: false → 文档不可读,记录警告并跳过

如果验证失败:
记录: "⚠️ 文档 [文件名] 无法读取: [错误原因]"
跳过该文档,继续处理下一个
```

#### 4.2 选择合适的解析工具

根据文件扩展名选择对应的插件 MCP 工具:

```
- .docx → 使用 mcp__construction_doc_processor__parse_word_document
  参数:
    - file_path: [文档路径]
    - extract_tables: true

- .xlsx → 使用 mcp__construction_doc_processor__parse_excel_document
  参数:
    - file_path: [文档路径]
    - max_rows: 100

- .pptx → 使用 mcp__construction_doc_processor__parse_powerpoint_document
  参数:
    - file_path: [文档路径]
    - extract_notes: true

- .pdf → 使用 mcp__construction_doc_processor__parse_pdf_document
  参数:
    - file_path: [文档路径]
    - extract_tables: false
    - max_pages: 50
```

**解析示例**:
```
对于 Word 文档:
mcp__construction_doc_processor__parse_word_document:
  - file_path: /Volumes/MOVESPEED/projectDocs2/项目概况.docx
  - include_tables: true

解析器会返回:
- paragraphs: 段落内容列表
- tables: 表格数据
- metadata: 文档元数据(作者、创建时间等)
```

#### 4.3 智能信息提取

对于重要文档,重点提取建筑行业关键信息:

**建筑关键词库**:
- 进度相关: "计划完成"、"实际完成"、"工期"、"进度"、"延期"、"提前"
- 质量相关: "验收"、"合格"、"不合格"、"整改"、"质量问题"
- 安全相关: "安全检查"、"隐患"、"事故"、"整改"
- 成本相关: "造价"、"成本"、"费用"、"预算"
- 材料相关: "材料"、"进场"、"合格证"、"试验"

**提取策略**:
```
从解析结果中提取关键段落:
1. 筛选包含关键词的段落
2. 提取相关表格数据
3. 记录信息来源(文档名称、页码)
```

#### 4.4 批量处理优化

如果需要读取多个文档(>3个),使用高效策略:

```
策略 1: 优先级排序
- 高优先级: 概况、总结、月报类文档(必读)
- 中优先级: 验收记录、检查记录(选读)
- 低优先级: 详细技术资料(按需)

策略 2: 控制读取量
- 单次任务最多读取 10 个文档
- 超过 10 个时,选择最重要的读取
- 其他文档仅获取元数据

策略 3: 元数据快速浏览
对不需要详细读取的文档,使用:
mcp__construction_doc_processor__get_document_metadata:
  - file_path: [文档路径]
仅获取文件名、大小、修改时间等信息
```

### 5. 容错处理 ⭐ (重要)

如果文档解析失败,使用回退策略:

#### 回退策略

```
第一步: 尝试验证
使用 mcp__construction_doc_processor__validate_document 检查文档

第二步: 尝试获取元数据
如果验证失败,尝试:
mcp__construction_doc_processor__get_document_metadata

第三步: 友好提示
在报告中标注:
"⚠️ 文档 [文件名] 内容无法读取,可能原因:
  - 文档格式损坏
  - 文件权限不足
  - 文件被占用
建议: 请手动检查该文档并补充关键信息"

第四步: 继续流程
不要因为单个文档失败而中断整个总结流程
```

#### 错误统计

```
维护文档读取状态:
- 成功读取: count_success
- 部分读取: count_partial (仅元数据)
- 读取失败: count_failed

在最终报告中展示统计信息
```

### 6. 生成总结报告

#### 6.1 创建文档读取状态表

在报告开头添加文档读取情况说明:

```markdown
## 📊 文档读取情况

| 文档名称 | 类型 | 大小 | 状态 | 提取内容 |
|---------|------|------|------|---------|
| 项目概况.pptx | PPT | 2.3MB | ✅ 成功 | 15张幻灯片,3个表格 |
| 施工月报-9月.xlsx | Excel | 156KB | ✅ 成功 | 3个工作表,45行数据 |
| 验收记录.docx | Word | 89KB | ⚠️ 部分 | 仅元数据(无法读取内容) |
| 损坏文件.doc | Word | 0KB | ❌ 失败 | 文件损坏或格式不支持 |

**统计**: 成功 2 个 | 部分 1 个 | 失败 1 个 | 总计 4 个
```

#### 6.2 整合信息生成总结

根据成功读取的文档内容,生成结构化总结:

```markdown
# 建筑施工项目总结报告

> **项目名称**: [从配置文件读取]
> **总结范围**: [整体/阶段/时期]
> **生成时间**: [当前时间戳]
> **数据来源**: 成功读取 X 个文档,部分读取 Y 个,失败 Z 个

---

## 一、项目概况

[从项目概况文档提取]

**基本信息**:
- 项目名称: [从配置或文档提取]
- 建设地点: [从配置或文档提取]
- 建设规模: [从文档提取]
- 建设单位: [从配置提取]
- 施工单位: [从配置提取]
- 监理单位: [从配置提取]

**来源**: 《项目概况.pptx》(原文档目录/项目管理/项目概况.pptx)

---

## 二、主要完成工作

[从月报、周报、验收记录等文档提取]

### 2.1 总体进度

根据《施工月报-2024年9月》(原文档目录/月报/施工月报-2024年9月.xlsx):

- 计划完成工程量: [提取数据]
- 实际完成工程量: [提取数据]
- 完成率: [计算百分比]
- 进度评价: [提取评价]

### 2.2 主要施工内容

根据多份施工记录整理:

1. **[工作项1]**
   - 完成情况: [描述]
   - 来源: 《[文档名称]》

2. **[工作项2]**
   - 完成情况: [描述]
   - 来源: 《[文档名称]》

---

## 三、质量管理情况

[从验收记录、质量检查记录提取]

### 3.1 质量验收

根据《分部工程验收记录》(原文档目录/质量验收/):

- 验收项目: [列表]
- 验收结果: [合格/不合格]
- 质量评定: [评定等级]

### 3.2 质量问题与整改

[如果发现质量问题记录]

- 发现问题: [描述]
- 整改措施: [描述]
- 整改结果: [描述]
- 来源: 《[文档名称]》

---

## 四、安全管理情况

[从安全检查记录、会议纪要提取]

### 4.1 安全检查

根据《安全检查记录》(原文档目录/安全管理/):

- 检查次数: [次数]
- 发现隐患: [数量]
- 整改完成: [数量]
- 安全评价: [评价]

### 4.2 安全教育培训

- 培训次数: [次数]
- 参训人数: [人数]
- 来源: 《[文档名称]》

---

## 五、存在问题与挑战

[从各类文档中提取问题描述]

### 5.1 进度问题

[如有延期或进度问题]

- 问题描述: [描述]
- 影响分析: [分析]
- 解决措施: [措施]

### 5.2 质量问题

[如有质量问题]

### 5.3 其他问题

[其他发现的问题]

---

## 六、经验与总结

[从总结类文档或会议纪要提取]

### 6.1 成功经验

- [经验1]
- [经验2]

### 6.2 改进建议

- [建议1]
- [建议2]

---

## 七、下一步工作计划

[从月报、会议纪要中提取]

根据《[文档名称]》:

1. **[计划项1]**
   - 计划时间: [时间]
   - 责任单位: [单位]

2. **[计划项2]**
   - 计划时间: [时间]
   - 责任单位: [单位]

---

## 附录: 参考文档列表

本报告基于以下文档生成:

### ✅ 完整提取文档 (X 个)

1. 《项目概况.pptx》- 原文档目录/项目管理/项目概况.pptx
   - 提取内容: 项目基本信息、参建单位信息
2. 《施工月报-9月.xlsx》- 原文档目录/月报/施工月报-9月.xlsx
   - 提取内容: 进度数据、完成情况

### ⚠️ 部分提取文档 (Y 个)

1. 《验收记录.docx》- 原文档目录/质量验收/验收记录.docx
   - 仅获取元数据,内容无法读取
   - 建议: 手动检查并补充验收信息

### ❌ 提取失败文档 (Z 个)

1. 《损坏文件.doc》- 原文档目录/其他/损坏文件.doc
   - 错误原因: 文件格式损坏
   - 建议: 请检查文件完整性或提供新版本

---

## 📋 报告质量说明

**数据准确性**: 本报告所有数据均来自原始文档,未经修改

**信息完整性**:
- ✅ 成功读取 X 个文档,信息完整性较高
- ⚠️ Y 个文档部分读取,可能存在信息缺失
- ❌ Z 个文档读取失败,请人工补充

**使用建议**:
1. 请人工审核所有关键数据
2. 对标注"部分提取"的内容,建议手动补充
3. 对标注"提取失败"的文档,请重新检查
4. 本报告可作为正式报告的草稿,需要人工完善

---

**生成时间**: [YYYY-MM-DD HH:MM:SS]
**生成工具**: 建筑施工文档助手 v1.1.0
```

### 7. 保存Markdown报告

使用 Write 工具保存报告到:

```
生成文件/项目总结/项目总结-[范围]-YYYYMMDD-HHMMSS.md
```

例如:
- 整体总结: `生成文件/项目总结/项目总结-整体-20251014-143022.md`
- 阶段总结: `生成文件/项目总结/项目总结-主体结构阶段-20251014-143022.md`
- 时期总结: `生成文件/项目总结/项目总结-2024年9月-20251014-143022.md`

### 8. 生成Word文档 ⭐ (新增)

#### 8.1 调用Word生成工具

使用 MCP 工具生成专业排版的Word文档:

```
mcp__construction_doc_processor__generate_word_report:
  markdown_file: [步骤7保存的Markdown文件路径]
  output_file: [同目录下,将.md替换为.docx]
  template_type: "project_summary"
  project_info:
    project_name: [从配置文件读取的项目名称]
    report_type: "项目总结报告"
    generate_date: [当前日期 YYYY-MM-DD格式]
```

**参数说明**:
- `markdown_file`: 步骤7生成的Markdown文件的绝对路径
- `output_file`: Word文档输出路径(与Markdown同目录,扩展名改为.docx)
- `template_type`: 使用"project_summary"模板(项目总结报告样式)
- `project_info`: 项目信息,用于生成页眉页脚

**示例**:
```
mcp__construction_doc_processor__generate_word_report:
  markdown_file: "生成文件/项目总结/项目总结-整体-20251015-143022.md"
  output_file: "生成文件/项目总结/项目总结-整体-20251015-143022.docx"
  template_type: "project_summary"
  project_info:
    project_name: "XX建设项目"
    report_type: "项目总结报告"
    generate_date: "2025-10-15"
```

#### 8.2 处理生成结果

**如果Word生成成功**:
- 工具会返回成功信息,包含文件路径和大小
- 继续执行步骤9

**如果Word生成失败**:
- 显示错误信息
- Markdown文件仍然可用
- 提示: "Word生成失败,Markdown报告已保存,可手动转换或稍后重试"
- 继续执行步骤9(不中断流程)

#### 8.3 Word文档特性

生成的Word文档包含:
- ✅ 专业排版(符合建筑行业文档规范)
- ✅ 页眉:项目名称 | 报告类型
- ✅ 页脚:自动页码
- ✅ 标题层级样式(一级标题22pt黑体,二级标题16pt黑体等)
- ✅ 表格样式(三线表,表头加粗蓝色背景)
- ✅ 正文样式(宋体12pt,1.5倍行距)
- 🔲 图片占位符(Phase 1暂不支持图片,显示"[图片: 说明]")

### 9. 输出完成信息(更新版)

```
✅ 项目总结生成完成

📊 统计信息:
  - 扫描文档: [总数] 个
  - 成功读取: [成功数] 个
  - 部分读取: [部分数] 个 (仅元数据)
  - 读取失败: [失败数] 个
  - 总结长度: [字符数] 字符

📄 生成文件:
  - Markdown报告: 生成文件/项目总结/项目总结-[范围]-20251015-143022.md
  - Word文档: 生成文件/项目总结/项目总结-[范围]-20251015-143022.docx ⭐
  - Word文件大小: [文件大小] MB

📋 内容概要:
  - 项目概况: ✅
  - 完成工作: ✅
  - 质量情况: ✅
  - 安全情况: ✅
  - 存在问题: [有/无]
  - 下步计划: ✅

💡 重要提示:
  ⚠️ [失败数] 个文档无法读取,请检查:
     - [失败文档1]
     - [失败文档2]

  ⚠️ [部分数] 个文档仅获取元数据,建议手动补充:
     - [部分文档1]
     - [部分文档2]

  ✅ 建议操作:
     1. 打开Word文档进行人工审核(推荐直接编辑Word版本)
     2. 对比原始文档验证关键数据
     3. 补充无法自动提取的信息
     4. 如需调整样式,可在Word中直接修改
     5. Markdown文件作为源文件保留,便于后续重新生成
```

---

## 🔑 关键改进点总结

### 相比旧版本的改进

**改进前** (使用 Read 工具):
- ❌ PowerPoint 文档无法读取
- ❌ Excel 文档经常失败
- ❌ 单个文档失败导致流程中断
- ❌ 没有错误提示和建议

**改进后** (使用 MCP 工具):
- ✅ 支持 Word、Excel、PowerPoint、PDF 四种格式
- ✅ 文档验证机制,提前发现问题
- ✅ 智能容错,单个失败不影响整体
- ✅ 友好的错误提示和改进建议
- ✅ 批量处理优化,提高效率
- ✅ 建筑关键词智能提取
- ✅ 完整的文档读取状态追踪

### 核心优势

1. **可靠性**: 使用专业的文档解析库,成功率大幅提升
2. **智能性**: 自动识别和提取建筑行业关键信息
3. **容错性**: 多级回退机制,确保流程不中断
4. **可追溯性**: 每条信息都标注来源文档
5. **用户友好**: 清晰的错误提示和操作建议

---

**质量要求**:
- ✅ 数据准确,有依据
- ✅ 重要信息标注来源
- ✅ 客观描述,不夸大不隐瞒
- ✅ 错误处理友好,有建议
- ✅ 报告结构清晰,易于阅读
